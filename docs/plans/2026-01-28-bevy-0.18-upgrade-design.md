# Bevy 0.18 Upgrade Design

**Date:** 2026-01-28
**Status:** Implemented
**Scope:** Upgrade Bevy from 0.17 to 0.18, including all related dependencies

## Summary

Upgrade AirJedi to Bevy 0.18 with matching egui crates. The primary blocker is `bevy_slippy_tiles` which doesn't have a 0.18-compatible release yet. Solution: fork and patch until upstream releases version 0.11.

## Dependency Changes

### Cargo.toml Updates

```toml
[dependencies]
# Core framework
bevy = "0.18"                    # was "0.17"

# Slippy tiles - use git fork until 0.11 releases
bevy_slippy_tiles = { git = "https://github.com/YOUR_USERNAME/bevy_slippy_tiles", branch = "bevy-0.18" }
# bevy_slippy_tiles = "0.11"    # uncomment when released upstream

# Egui integration
bevy_egui = "0.39"               # was "0.38"

# These remain unchanged
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
reqwest = { version = "0.12", features = ["blocking"] }
tokio = { version = "1", features = ["rt-multi-thread", "macros", "time", "sync"] }
chrono = { version = "0.4", features = ["serde"] }
toml = "0.8"
adsb-client = { path = "..." }
```

### bevy_slippy_tiles Fork

The `bevy_slippy_tiles` crate uses stable Bevy APIs that didn't change in 0.18:
- `Commands::spawn()`, `Res<T>`, `ResMut<T>`
- `MessageReader`, `MessageWriter`, `app.add_message()`
- `Sprite::from_image()`, `Transform::from_xyz()`
- `AssetServer::load()`

Only dependency version bumps needed in the fork:
- `bevy = "0.17"` → `bevy = "0.18"`
- `bevy_platform = "0.17"` → `bevy_platform = "0.18"`

## Code Migration Analysis

### AirJedi Code Changes Required: None

After analyzing `src/main.rs` and `src/config.rs` against the Bevy 0.18 migration guide, no breaking API changes affect this codebase:

| API Used | Status |
|----------|--------|
| `Camera2d` spawn | Unchanged |
| `Projection::Orthographic` | Unchanged |
| `MouseWheel` / `CursorMoved` events | Unchanged |
| `ButtonInput<MouseButton/KeyCode>` | Unchanged |
| `Text`, `Text2d`, `TextFont`, `TextColor` | Unchanged |
| `Sprite`, `Transform` | Unchanged |
| `Mesh2d`, `MeshMaterial2d` | Unchanged |
| `Query`, `Res`, `ResMut`, `Commands` | Unchanged |
| `MessageReader`, `MessageWriter` | Unchanged |
| `ApplyDeferred` system ordering | Unchanged |
| bevy_egui APIs | Unchanged (verify on compile) |

### Migration Guide Changes Not Applicable

These 0.18 breaking changes don't affect AirJedi:

1. **Entity API** (`EntityRow` → `EntityIndex`) - Not used
2. **RenderTarget as component** - No render-to-texture
3. **Camera target field removal** - Using default camera
4. **BorderRadius in Node** - Not using border radius
5. **LineHeight component** - Not customizing line height
6. **Material plugin changes** - Using ColorMaterial, not custom materials
7. **Mesh try_* methods** - Not accessing mesh data directly
8. **Input feature flags** - Using default features

## New Bevy 0.18 Features

### Potentially Useful

1. **System Condition Combinators** - Now treat failures as `false` instead of propagating errors. Benefits the `run_if(not(egui_wants_any_pointer_input))` patterns by being more resilient during startup.

2. **Image Array Textures** - `ImageLoaderSettings::array_layout` allows loading tile atlases directly. Could optimize tile batching in future.

3. **State Transition Changes** - If adding app states (loading, menu, etc.), use `set_if_neq()` to avoid redundant transitions.

### Not Applicable

- glTF coordinate conversion changes
- Draw function per-phase changes
- Pipeline descriptor changes
- Feature renames (not using affected features)

## Implementation Checklist

### Phase 1: Prepare bevy_slippy_tiles Fork

- [ ] Fork `edouardpoitras/bevy_slippy_tiles` to your GitHub
- [ ] Clone fork locally
- [ ] Create `bevy-0.18` branch
- [ ] Update fork's `Cargo.toml`:
  ```toml
  bevy = "0.18"
  bevy_platform = "0.18"
  ```
- [ ] Run `cargo build` and `cargo test`
- [ ] Push branch to fork

### Phase 2: Update AirJedi Dependencies

- [ ] Update `Cargo.toml` with new versions
- [ ] Run `cargo update`
- [ ] Run `cargo build` - fix any errors

### Phase 3: Verify Functionality

- [ ] Run app: `cargo run`
- [ ] Test map panning (click-drag)
- [ ] Test zoom (scroll wheel and trackpad)
- [ ] Test tile loading and caching
- [ ] Test Settings panel (egui)
- [ ] Test ADS-B connection
- [ ] Test aircraft display and labels
- [ ] Test Clear Cache button

### Phase 4: Cleanup

- [ ] Run `cargo clippy`
- [ ] Update CLAUDE.md version references
- [ ] Commit: "Upgrade to Bevy 0.18"
- [ ] (Optional) Submit PR to upstream bevy_slippy_tiles

## Risk Assessment

**Risk Level: Low**

- No breaking API changes in AirJedi code
- bevy_slippy_tiles fork requires only Cargo.toml changes
- bevy_egui 0.39 is a straightforward update
- All functionality can be verified with manual testing

## References

- [Bevy 0.17 to 0.18 Migration Guide](https://bevy.org/learn/migration-guides/0-17-to-0-18/)
- [bevy_egui Releases](https://github.com/vladbat00/bevy_egui/releases)
- [bevy_slippy_tiles Repository](https://github.com/edouardpoitras/bevy_slippy_tiles)
